<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Echo server - Unikernels in OCaml and network</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-ba81fcc6.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-f346a6d4.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Unikernels in OCaml and network</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <p><code>mnet</code> is a TCP/IP stack written entirely in OCaml, designed for unikernels.
Because the network stack is reimplemented in a memory-safe language, <code>mnet</code>
benefits from OCaml’s type system and from the broader ecosystem of formal
verification tools that can produce correct-by-construction OCaml code. This
means fewer classes of bugs (no buffer overflows, no use-after-free) and a
codebase that is easier to audit and reason about than a traditional C
implementation.</p>
<h2 id="a-note-on-performance"><a class="header" href="#a-note-on-performance">A note on performance</a></h2>
<p>Before going further, it is worth setting realistic expectations about
performance.</p>
<p>A pure OCaml TCP/IP stack will not match the raw throughput of an optimized
C implementation. The garbage collector introduces pause times, and OCaml’s
memory representation adds some overhead compared to bare pointers and manual
memory management.</p>
<p>However, the language is only part of the story. Regardless of whether a
unikernel is written in OCaml or C, it faces an inherent I/O disadvantage
compared to an application running directly on the host. A regular process on
Linux can make system calls that interact with the kernel’s network stack
directly. A unikernel cannot: it runs inside a sandboxed environment and must
go through two layers of indirection for every I/O operation. First, the
unikernel issues a hypercall to the tender (the host-side process that manages
the virtual machine). Then, the tender issues a system call to the host kernel,
which actually performs the I/O. This double indirection adds latency to every
network operation. There are techniques to reduce this cost (for example,
shared-memory ring buffers between the tender and the unikernel, similar to
what <code>virtio</code> provides), but the overhead can never be fully eliminated. This
is a fundamental constraint of the isolation model, not a limitation of any
particular implementation.</p>
<p>If your goal is to build the fastest possible web server, a unikernel is not
the right tool. But raw throughput is rarely the only metric that matters.
Unikernels excel in other dimensions: they have a minimal attack surface
because there is no shell, no unused drivers, and no package manager, only the
code your application needs. They boot in milliseconds because there is no
operating system to initialize, and their images are only a few megabytes
compared to hundreds for a typical container. The per-instance cost of running
a unikernel is therefore very low.</p>
<p>These properties naturally lead to a different way of thinking about services.
Rather than building a single monolithic application, you can decompose your
system into small, focused unikernels, where each one does one thing, boots
quickly, and consumes minimal resources. The deployment cost per component
becomes low enough that this architecture is practical, not just theoretical.</p>
<p>In short, do not expect a unikernel to outperform a native application in I/O.
Instead, think of unikernels as a way to build smaller, safer, and more
composable services.</p>
<h2 id="initialization"><a class="header" href="#initialization">Initialization</a></h2>
<p>The TCP/IP stack depends on a source of randomness (for generating TCP sequence
numbers, IPv6 addresses, and so on). We use <code>mirage-crypto</code> with its
<a href="https://en.wikipedia.org/wiki/Fortuna_(PRNG)">Fortuna</a> engine for this purpose. <code>mkernel</code> provides a mechanism to
declare the resources that a unikernel needs before it starts, including
devices (such as a network interface) and other values that require
initialization. To set up a working TCP/IP stack, we need three things: the
static IPv4 address to assign to the unikernel, an initialized random number
generator, and a network device (here named <code>"service"</code>).</p>
<pre><code class="language-ocaml">module RNG = Mirage_crypto_rng.Fortuna

let ( let@ ) finally fn = Fun.protect ~finally fn
let rng () = Mirage_crypto_rng_mkernel.initialize (module RNG)
let rng = Mkernel.map rng Mkernel.[]

let () =
  let ipv4 = Ipaddr.V4.Prefix.of_string_exn "10.0.0.2/24" in
  Mkernel.(run [ rng; Mnet.stack ~name:"service" ipv4 ])
  @@ fun rng (stack, _tcp, _udp) () -&gt;
  let@ () = fun () -&gt; Mirage_crypto_rng_mkernel.kill rng in
  let@ () = fun () -&gt; Mnet.kill stack in
  print_endline "Hello World!"
</code></pre>
<p>One important thing to notice in this code is the use of finalizers. Every
resource we create is paired with a cleanup function via the <code>let@</code> operator
(which is a shorthand for <code>Fun.protect ~finally</code>). This is not optional: Miou,
the scheduler used in our unikernels, requires that all resources be properly
released before the program exits. The random number generator, for instance,
spawns a background task that continuously feeds entropy to the Fortuna engine.
If that task is not terminated explicitly with
<code>Mirage_crypto_rng_mkernel.kill</code>, the scheduler will reject the program at
exit. The <a href="https://robur-coop.github.io/miou/retrospective.html#a-task-as-a-resource">Miou tutorial</a> covers this topic in more detail.</p>
<p>The same principle applies to <code>mnet</code>. Calling <code>Mnet.stack</code> starts several
background daemons (an Ethernet frame reader, an ARP responder, TCP timers, and
others) that run for the entire lifetime of the stack. <code>Mnet.kill</code> terminates
all of them. Forgetting to call it would leave dangling tasks, which Miou
treats as an error.</p>
<p>This cleanup pattern is not specific to unikernels: it applies to every
application built with Miou. Whenever you create a long-lived resource, you
should attach a finalizer to ensure it is released, even if an exception
interrupts the normal control flow.</p>
<h2 id="compilation"><a class="header" href="#compilation">Compilation</a></h2>
<p>As explained in the introduction, cross-compiling a unikernel with
<code>ocaml-solo5</code> requires that the source code of all dependencies (including
transitive ones) be available locally in a <code>vendors/</code> directory. Our echo
server depends on <code>mnet</code> and its own transitive dependencies, so we need to
vendor all of them. There is one point worth mentioning about <a href="https://github.com/xavierleroy/Zarith">Zarith</a>: it needs to be
compiled with <code>dune</code>. For several years, the Mirage team has maintained a fork
of Zarith that uses <code>dune</code>, available <a href="https://github.com/mirage/Zarith">here</a>. To make unikernel
compilation work, we need to <em>pin</em> this package. Here are the commands to
run:</p>
<pre><code class="language-bash">$ opam pin git+https://github.com/mirage/Zarith.git#zarith-1.14
$ opam source bstr --dir vendors/bstr
$ opam source mnet --dir vendors/mnet
$ opam source mirage-crypto-rng-mkernel --dir vendors/mirage-crypto-rng-mkernel
$ opam source gmp --dir vendors/gmp
$ opam source digestif --dir vendors/digestif
$ opam source kdf --dir vendors/kdf
$ opam source utcp --dir vendors/utcp
$ opam source zarith --dir vendors/zarith
</code></pre>
<p>Next, we update the <code>dune</code> file to declare the libraries our unikernel depends
on, the Solo5 ABI we are targeting, and the C stub for the device manifest:</p>
<pre><code class="language-dune">(executable
 (name main)
 (modules main)
 (link_flags :standard -cclib "-z solo5-abi=hvt")
 (libraries
  mkernel
  mirage-crypto-rng-mkernel
  mnet
  gmp)
 (foreign_stubs
  (language c)
  (names manifest)))
</code></pre>
<p>Finally, since our unikernel now uses a network device, we need to declare it
in <code>manifest.json</code>. The name <code>"service"</code> must match the <code>name</code> argument we
passed to <code>Mnet.stack</code> in the code above:</p>
<pre><code class="language-json">{"type":"solo5.manifest","version":1,"devices":[{"name":"service","type":"NET_BASIC"}]}
</code></pre>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>To simplify the workflow around device manifests, you can <em>run</em> your unikernel
as a regular executable, and it will print the manifest it expects to stdout:</p>
<pre><code class="language-bash">$ dune exec ./main.exe &gt; manifest.json
</code></pre>
</blockquote>
<h2 id="network-configuration"><a class="header" href="#network-configuration">Network configuration</a></h2>
<p>Before we can run our unikernel, we need to set up a virtual network on the
host. This step is necessary because a unikernel does not share the host’s
network stack; it implements its own (that is the whole point of <code>mnet</code>). From
the unikernel’s perspective, it is a machine with its own Ethernet interface,
its own IP address, and its own TCP/IP stack. It needs to be connected to a
network just like a physical machine would be plugged into a switch.</p>
<p>On Linux, we can create this virtual network using two standard kernel
features: <a href="https://en.wikipedia.org/wiki/TUN/TAP">tap interfaces</a> and bridges (<code>bridge-utils</code>).</p>
<p>Think of a physical network in an office. Each computer has an Ethernet port
and a cable that connects it to a switch (a device whose only job is to forward
Ethernet frames between the machines plugged into it). Any machine on the
switch can talk to any other machine on the same switch, because the switch
delivers each frame to the right port based on the destination MAC address.
This forms what is called a local area network, or LAN.</p>
<p>We need to reproduce this setup virtually. A tap interface plays the role of
the Ethernet cable: it is a network device created by the Linux kernel that
behaves like a physical network card, except that no real hardware is involved.
When the tender (<code>solo5-hvt</code>) starts the unikernel, it attaches the unikernel’s
network device to a tap interface. From that point on, every Ethernet frame
that the unikernel sends appears on the tap interface, and every frame written
to the tap interface is delivered to the unikernel. A bridge plays the role of
the switch: it connects several network interfaces together and forwards
Ethernet frames between them. When we attach the tap interface to a bridge, the
unikernel becomes part of the local network formed by that bridge, just as
plugging a cable into a switch makes a computer part of the office LAN.</p>
<p>There is one more piece to the puzzle. A local network lets machines talk to
each other, but it does not, by itself, provide access to the outside world. In
our office analogy, the switch connects the computers to each other, but there
must be a router somewhere that connects the office LAN to the internet. That
router is what we call a gateway: it is the machine that knows how to forward
packets beyond the local network. When a machine wants to reach an IP address
that is not on its local network, it sends the packet to the gateway, and the
gateway takes care of routing it further.</p>
<p>In our setup, the host plays the role of the gateway. We assign an IPv4 address
to the bridge, which gives the host a presence on the unikernel’s local
network. The unikernel is then configured to use that address as its gateway.
When the unikernel wants to reach an address outside the local network (for
instance, a DNS server on the internet) it sends the packet to the host via the
bridge, and the host forwards it through its own network connection.</p>
<p>This is admittedly more system administration than development. The
configuration we describe here is simple and generic; your network topology may
require adjustments. But it is worth understanding what these pieces do,
because a unikernel sits at the intersection of application development and
deployment. Understanding both sides is part of what makes the unikernel
approach powerful.</p>
<p>Here is how to set this up on Linux:</p>
<pre><code class="language-bash">$ sudo ip link add br0 type bridge
$ sudo ip addr add 10.0.0.1/24 dev br0
$ sudo ip tuntap add tap0 mode tap
$ sudo ip link set tap0 master br0
$ sudo ip link set br0 up
$ sudo ip link set tap0 up
</code></pre>
<p>The first command creates a bridge named <code>br0</code>. The second assigns it the
address <code>10.0.0.1</code> on the <code>10.0.0.0/24</code> subnet (this is the address the
unikernel will use as its gateway). The third command creates a tap interface
named <code>tap0</code>. The fourth attaches it to the bridge, and the last two bring both
interfaces up.</p>
<h2 id="launching-our-unikernel"><a class="header" href="#launching-our-unikernel">Launching our unikernel</a></h2>
<p>Now that the network is in place, we can run our unikernel. The
<code>--net:service=tap0</code> flag tells the tender to connect the unikernel’s
<code>"service"</code> network device to the <code>tap0</code> interface we just created:</p>
<pre><code class="language-bash">$ solo5-hvt --net:service=tap0 -- ./_build/solo5/main.exe --solo5:quiet
Hello World!
</code></pre>
<p>The output looks the same as before: the unikernel prints its message and
exits. But behind the scenes, something new happened. <code>mnet</code> initialized its
TCP/IP stack and connected to the virtual network. We can observe this by
capturing traffic on the bridge with <code>tcpdump</code>:</p>
<pre><code class="language-bash">$ sudo tcpdump -i br0
listening on br0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
14:30:00.000000 ARP, Request who-has 10.0.0.2 tell 10.0.0.2, length 28
</code></pre>
<p>The ARP request you see is the unikernel announcing its presence on the local
network. It is asking <em>who has this IP address?</em> to verify that no other
machine is already using it. This is a standard part of the IPv4 initialization
process (known as Gratuitous ARP).</p>
<h2 id="implementing-the-echo-server"><a class="header" href="#implementing-the-echo-server">Implementing the echo server</a></h2>
<p>We can now turn our “Hello World” unikernel into an actual echo server. The
idea is straightforward: we listen on a TCP port, accept incoming connections,
and for each client, read whatever they send and write it back until they
disconnect.</p>
<p>If you have already followed the <a href="https://robur-coop.github.io/miou/echo.html">Miou tutorial</a>, the
concurrency pattern will look familiar. Each client connection is handled in its
own Miou task, and we use Miou’s <em>orphans</em> mechanism to keep track of these
tasks and collect their results as they complete.</p>
<pre><code class="language-ocaml">let handler flow =
  let finally = Mnet.TCP.close in
  let r = Miou.Ownership.create ~finally flow in
  Miou.Ownership.own r;
  let buf = Bytes.create 0x7ff in
  let rec go () =
    match Mnet.TCP.read flow buf with
    | 0 -&gt; Miou.Ownership.release r
    | len -&gt;
        let str = Bytes.sub_string buf 0 len in
        Mnet.TCP.write flow str;
        go () in
  go ()

let rec clean_up orphans =
  match Miou.care orphans with
  | Some None | None -&gt; ()
  | Some (Some prm) -&gt;
    match Miou.await prm with
    | Ok () -&gt; clean_up orphans
    | Error exn -&gt;
      Logs.err (fun m -&gt; m "Unexpected exception: %s" (Printexc.to_string exn))

let () =
  let ipv4 = Ipaddr.V4.Prefix.of_string_exn "10.0.0.2/24" in
  Mkernel.(run [ rng; Mnet.stack ~name:"service" ipv4 ])
  @@ fun rng (stack, tcp, _udp) () -&gt;
  let@ () = fun () -&gt; Mirage_crypto_rng_mkernel.kill rng in
  let@ () = fun () -&gt; Mnet.kill stack in
  let rec go orphans listen =
    clean_up orphans;
    let flow = Mnet.TCP.accept tcp listen in
    let _ = Miou.async ~orphans @@ fun () -&gt; handler flow in
    go orphans listen in
  go (Miou.orphans ()) (Mnet.TCP.listen tcp 9000)
</code></pre>
<p>The <code>handler</code> function is the per-client logic. It registers the TCP connection
(<code>flow</code>) with Miou’s ownership system so that the connection is automatically
closed if the task is cancelled or crashes. It then enters a loop where it
reads into a buffer, writes back what was received, and repeats. When the
client closes the connection, <code>read</code> returns <code>0</code> and the handler releases the
resource.</p>
<p>The <code>clean_up</code> function iterates over completed tasks in the <code>orphans</code> set.
This is how Miou lets you collect the results of concurrent tasks without
blocking the accept loop. If a handler raised an unexpected exception, we log
it here rather than letting it propagate silently.</p>
<p>The main entry point ties everything together. It initializes the stack (as we
saw earlier), then enters an accept loop where it waits for a new client with
<code>Mnet.TCP.accept</code>, spawns a handler task with <code>Miou.async</code>, and repeats. The
<code>Mnet.TCP.listen</code> call prepares port 9000 for incoming connections, much like
the <code>listen</code> system call in the Unix socket API.</p>
<p>You will notice that the <code>mnet</code> API intentionally mirrors the Unix socket API.
The <code>listen</code>, <code>accept</code>, <code>read</code>, <code>write</code>, and <code>close</code> functions all work the way
you would expect. This is a deliberate design choice: rather than inventing a
new abstraction, we keep the interface familiar so that the only new concepts
you need to learn are related to the unikernel model itself, not to the
networking API.</p>
<h2 id="testing-the-echo-server"><a class="header" href="#testing-the-echo-server">Testing the echo server</a></h2>
<p>We can now build, launch, and test the echo server. We start the unikernel in
the background, then connect to it with <code>nc</code> (netcat) from the host:</p>
<pre><code class="language-bash">$ solo5-hvt --net:service=tap0 -- ./_build/solo5/main.exe --solo5:quiet &amp;
$ UNIKERNEL=$!
$ nc -q0 10.0.0.2 9000
Hello World!
Hello World!
^D
$ kill $UNIKERNEL
solo5-hvt: Exiting on signal 15
</code></pre>
<p>We type “Hello World!” and the unikernel sends it right back. Pressing <code>Ctrl-D</code>
closes the connection. The <code>$!</code> variable captures the PID of the background
process so that we can stop the unikernel cleanly with <code>kill</code> when we are done.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>And with that, we have a working echo server running as a unikernel. As you
have seen, the process is fairly straightforward once you know the key steps:
vendor your dependencies, declare your devices, and configure the virtual
network on the host. The networking concepts (tap interfaces, bridges, and
gateways) may be unfamiliar if you come from a pure application development
background, but they quickly become second nature with a bit of practice.</p>
<p>Now that the foundations are in place, the fun really begins. In the next
chapter, we will build on what we have learned here and implement a web server.
Our <a href="https://robur.coop/">cooperative</a> provides implementations of several protocols (such as
<a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> and <a href="https://github.com/mirage/ocaml-dns">ocaml-dns</a>) that you can use to build
a wide range of services. We hope you are as excited as we are to see what you
will build next.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="web.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="web.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-5842b119.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
